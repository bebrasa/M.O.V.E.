<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EMG Visualization</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>Real-Time EMG Visualization</h1>
  <div class="lamp" id="lamp"></div>

  <!-- üîã –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–æ—â–Ω–æ—Å—Ç–∏ -->
  <h2>–ú–æ—â–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞</h2>
  <div id="power-indicator" style="width: 300px; height: 25px; border: 1px solid #000; background-color: #eee; position: relative; margin-bottom: 10px;">
    <div id="power-bar" style="height: 100%; width: 0%; background-color: green;"></div>
    <span id="power-text" style="position: absolute; top: 0; left: 10px; line-height: 25px; font-weight: bold;"></span>
  </div>

  <div id="emg-plot"></div>
  <h2>FFT Spectrum</h2>
  <div id="fft-plot"></div>

  <script>
    const socket = io();
    const maxPoints = 1000;

    Plotly.newPlot('emg-plot', [{
      x: [],
      y: [],
      mode: 'lines',
      line: { color: 'blue' },
      name: 'EMG Signal'
    }], {
      title: '–°–∏–≥–Ω–∞–ª EMG',
      xaxis: { title: '–í—Ä–µ–º—è (—Å)' },
      yaxis: { title: '–ê–º–ø–ª–∏—Ç—É–¥–∞', range: [-300, 300] }
    });

    Plotly.newPlot('fft-plot', [{
      x: [],
      y: [],
      mode: 'lines',
      line: { color: 'green' },
      name: 'FFT Spectrum'
    }], {
      title: '–°–ø–µ–∫—Ç—Ä —Å–∏–≥–Ω–∞–ª–∞',
      xaxis: { title: '–ß–∞—Å—Ç–æ—Ç–∞ (–ì—Ü)', range: [0, 100] },
      yaxis: { title: '–ê–º–ø–ª–∏—Ç—É–¥–∞' }
    });

    const lamp = document.getElementById('lamp');
    const powerBar = document.getElementById('power-bar');
    const powerText = document.getElementById('power-text');

    socket.emit('start_stream');

    socket.on('update_plot', (data) => {
      const x = data.x[0];
      const y = data.y[0];
      Plotly.extendTraces('emg-plot', {
        x: [[x]],
        y: [[y]]
      }, [0], maxPoints);
      lamp.classList.toggle('active', data.lamp_status);
    });

    socket.on('update_fft', (data) => {
      Plotly.update('fft-plot', {
        x: [data.freq],
        y: [data.amp]
      }, {}, [0]);

      // üîã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ percent_power –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      const percent = data.percent_power ?? 0;
      powerBar.style.width = percent + "%";
      powerBar.style.backgroundColor = percent > 70 ? "red" : (percent > 40 ? "orange" : "green");
      powerText.textContent = percent + " %";
    });
  </script>
</body>
</html>
